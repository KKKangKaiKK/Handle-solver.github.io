<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Handle Solver </title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
            background-color: #f9f9f9;
        }
        h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 15px;
            align-items: center;
        }
        label {
            font-weight: bold;
            text-align: right;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; /* Important for padding and width */
        }
        textarea {
            font-family: "Courier New", Courier, monospace;
            height: 100px;
            resize: vertical;
        }
        .button-group {
            grid-column: 1 / -1; /* Span across all columns */
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            color: white;
            transition: background-color 0.3s;
        }
        #btn-filter {
            background-color: #3498db;
        }
        #btn-filter:hover {
            background-color: #2980b9;
        }
        #btn-filter:disabled {
            background-color: #a9cce3;
            cursor: not-allowed;
        }
        #btn-reset {
            background-color: #e74c3c;
        }
        #btn-reset:hover {
            background-color: #c0392b;
        }
        #results-container {
            margin-top: 20px;
        }
        #results-list {
            list-style-type: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        #results-list li {
            background-color: #ecf0f1;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 1.1em;
        }
        #status {
            margin-top: 10px;
            font-style: italic;
            color: #7f8c8d;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>设置筛选规则</h2>
    <div id="status">正在加载成语数据...</div>
    <form id="filter-form">
        <div class="form-grid">
            <label for="py_includes">拼音包含:</label>
            <input type="text" id="py_includes" name="py_includes" placeholder="用空格分隔, 如: an j zh">

            <label for="py_excludes">拼音排除:</label>
            <input type="text" id="py_excludes" name="py_excludes" placeholder="用空格分隔, 如: iuang">

            <label for="tone_includes">声调包含:</label>
            <input type="text" id="tone_includes" name="tone_includes" placeholder="用空格分隔, 如: 1 4">

            <label for="tone_fixes">声调固定:</label>
            <input type="text" id="tone_fixes" name="tone_fixes" value="****" maxlength="4">

            <label for="py_fixes">拼音固定:</label>
            <textarea id="py_fixes" name="py_fixes" placeholder="请输入有效的JSON格式，如 [['d','ong'],['',''],['',''],['b','i']]"></textarea>
            
            <div class="button-group">
                <button type="submit" id="btn-filter" disabled>筛选</button>
                <button type="button" id="btn-reset">重置</button>
            </div>
        </div>
    </form>
</div>

<div id="results-container" class="container">
    <h2>筛选结果</h2>
    <div id="results-count"></div>
    <ul id="results-list"></ul>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- 全局变量和状态管理 ---
    let allIdioms = []; // 存储从JSON加载的所有成语数据
    
    // 默认筛选状态，模仿Python的session
    const defaultState = {
        py_includes: [],
        py_excludes: [],
        tone_includes: [],
        tone_fixes: '****',
        py_fixes: [['', ''], ['', ''], ['', ''], ['', '']],
        // 存储上一次筛选结果的索引，实现“在结果中继续筛选”
        // null 表示从全部数据开始筛选
        filteredIndices: null 
    };

    let filterState = { ...defaultState };

    // --- DOM 元素引用 ---
    const form = document.getElementById('filter-form');
    const statusDiv = document.getElementById('status');
    const btnFilter = document.getElementById('btn-filter');
    const btnReset = document.getElementById('btn-reset');
    const resultsCountDiv = document.getElementById('results-count');
    const resultsList = document.getElementById('results-list');
    
    // 输入框元素
    const inputPyIncludes = document.getElementById('py_includes');
    const inputPyExcludes = document.getElementById('py_excludes');
    const inputToneIncludes = document.getElementById('tone_includes');
    const inputToneFixes = document.getElementById('tone_fixes');
    const inputPyFixes = document.getElementById('py_fixes');

    // --- 核心逻辑函数 ---

    /**
     * 异步加载成语数据
     */
    async function loadIdioms() {
        try {
            const response = await fetch('idioms.json');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            allIdioms = await response.json();
            statusDiv.textContent = `加载完成，共 ${allIdioms.length} 条成语。`;
            btnFilter.disabled = false;
        } catch (error) {
            statusDiv.innerHTML = `<span class="error">加载成语数据失败 (idioms.json)。<br>请确保文件存在于同目录下，并通过本地服务器访问此页面。</span>`;
            console.error("Fetch error:", error);
        }
    }

    /**
     * 根据筛选条件搜索成语
     * @param {object} criteria - 包含所有筛选条件的对象
     * @returns {[Array<object>, Array<number>]} - 返回匹配的成语对象数组和它们的索引数组
     */
    function searchIdioms(criteria) {
        const { py_includes, py_excludes, tone_includes, tone_fixes, py_fixes, filteredIndices } = criteria;
        
        const outputs = [];
        const newIndices = [];

        // 确定要遍历的索引范围：是全部数据还是上次的结果
        const searchSpace = filteredIndices === null ? allIdioms.keys() : filteredIndices;

        for (const i of searchSpace) {
            const idiom = allIdioms[i];
            let isMatch = true;

            // 1. 拼音包含检查 (py_contains)
            // 组合所有拼音部分为一个数组，方便检查
            const allPinyinParts = [...idiom.initials, ...idiom.finals, ...idiom.pinyin];
            if (!py_includes.every(pc => allPinyinParts.includes(pc))) {
                continue; // 不满足条件，跳过此成语
            }

            // 2. 拼音排除检查 (py_excludes)
            if (!py_excludes.every(pec => !allPinyinParts.includes(pec))) {
                continue;
            }

            // 3. 声调包含检查 (tone_contains)
            if (!tone_includes.every(tc => idiom.tones.includes(tc))) {
                continue;
            }

            // 4. 声调固定检查 (tone_fixes)
            for (let j = 0; j < 4; j++) {
                if (tone_fixes[j] !== '*' && tone_fixes[j] !== idiom.tones[j]) {
                    isMatch = false;
                    break;
                }
            }
            if (!isMatch) continue;

            // 5. 拼音固定检查 (py_fixes)
            for (let j = 0; j < 4; j++) {
                // 检查声母
                if (py_fixes[j][0] && py_fixes[j][0] !== idiom.initials[j]) {
                    isMatch = false;
                    break;
                }
                // 检查韵母
                if (py_fixes[j][1] && py_fixes[j][1] !== idiom.finals[j]) {
                    isMatch = false;
                    break;
                }
            }
            if (!isMatch) continue;

            // 所有检查都通过
            outputs.push(idiom);
            newIndices.push(i);
        }

        return [outputs, newIndices];
    }

    /**
     * 将筛选结果渲染到页面上
     * @param {Array<object>} results - 匹配的成语对象数组
     */
    function renderResults(results) {
        resultsCountDiv.textContent = `找到 ${results.length} 个结果。`;
        resultsList.innerHTML = ''; // 清空旧结果
        
        if (results.length === 0) {
            return;
        }

        const fragment = document.createDocumentFragment();
        results.forEach(result => {
            const li = document.createElement('li');
            li.textContent = result.idiom;
            fragment.appendChild(li);
        });
        resultsList.appendChild(fragment);
    }
    
    /**
     * 将当前状态更新到表单输入框中
     */
    function updateFormFromState() {
        inputPyIncludes.value = filterState.py_includes.join(' ');
        inputPyExcludes.value = filterState.py_excludes.join(' ');
        inputToneIncludes.value = filterState.tone_includes.join(' ');
        inputToneFixes.value = filterState.tone_fixes;
        // 格式化JSON输出，方便阅读
        inputPyFixes.value = JSON.stringify(filterState.py_fixes, null, 2);
    }

    // --- 事件处理 ---

    /**
     * 处理筛选按钮点击事件
     */
    function handleFilter(event) {
        event.preventDefault(); // 阻止表单默认提交行为
        btnFilter.disabled = true;
        btnFilter.textContent = '筛选中...';

        // 从表单获取并更新筛选状态
        filterState.py_includes = inputPyIncludes.value.trim().split(' ').filter(Boolean);
        filterState.py_excludes = inputPyExcludes.value.trim().split(' ').filter(Boolean);
        filterState.tone_includes = inputToneIncludes.value.trim().split(' ').filter(Boolean);
        filterState.tone_fixes = inputToneFixes.value || '****';
        
        // 安全地解析py_fixes输入
        try {
            const parsedPyFixes = JSON.parse(inputPyFixes.value);
            // 简单的验证，确保是 4x2 的数组结构
            if (Array.isArray(parsedPyFixes) && parsedPyFixes.length === 4 && parsedPyFixes.every(p => Array.isArray(p) && p.length === 2)) {
                filterState.py_fixes = parsedPyFixes;
            } else {
                throw new Error("格式不正确，需要是 [[s,y],[s,y],[s,y],[s,y]] 结构。");
            }
        } catch (e) {
            alert(`拼音固定格式错误: ${e.message}`);
            btnFilter.disabled = false;
            btnFilter.textContent = '筛选';
            return;
        }

        // 使用 setTimeout 给予浏览器渲染“筛选中”状态的时间
        setTimeout(() => {
            const [results, newIndices] = searchIdioms(filterState);
            
            // 更新下一次筛选的范围
            filterState.filteredIndices = newIndices;
            
            renderResults(results);
            
            btnFilter.disabled = false;
            btnFilter.textContent = '筛选';
        }, 10);
    }

    /**
     * 处理重置按钮点击事件
     */
    function handleReset() {
        filterState = { ...defaultState };
        updateFormFromState();
        renderResults([]); // 清空结果显示
        resultsCountDiv.textContent = '';
        statusDiv.textContent = `筛选条件已重置。当前成语库总量: ${allIdioms.length}。`;
    }

    // --- 初始化和事件绑定 ---
    
    // 页面加载后立即加载数据和初始化表单
    loadIdioms();
    updateFormFromState();
    
    // 绑定事件
    form.addEventListener('submit', handleFilter);
    btnReset.addEventListener('click', handleReset);
});
</script>

</body>
</html>
